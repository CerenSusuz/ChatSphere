@page "/chathub"
@using ChatSphere.Client.Shared
@using ChatSphere.Domain.DTOs
@inject IChatService ChatService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Chat - ChatSphere</PageTitle>

@if (ChatService == null || !ChatService.IsConnected)
{
    <p>Connecting to chat...</p>
}
else
{
    <div class="theme-button-container">
        <ThemeToggle />
    </div>

    <div class="chat-wrapper">
        <!-- Sidebar: Room list & users -->
        <div class="sidebar">
            <h3>Rooms</h3>
            <div class="room-list">
                @foreach (var room in availableRooms)
                {
                    <div class="room-item" @onclick="() => SelectRoom(room.Id)">
                        @room.Name
                    </div>
                }
            </div>

            <div class="room-selection">
                <input placeholder="Selected Room ID..." @bind="roomId" readonly />
                <button class="join-btn" @onclick="JoinRoom" disabled="@(!CanJoinRoom)">Join</button>
            </div>

            @if (currentRoom != Guid.Empty)
            {
                <h4>Users in Room</h4>
                <div class="user-list">
                    @foreach (var user in ChatService.UsersInCurrentRoom)
                    {
                        <div class="user-item">@user</div>
                    }
                </div>
            }
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h3>ChatSphere</h3>
            </div>

            <div class="chat-messages">
                @foreach (var msg in ChatService.ChatMessages)
                {
                    <div class="message @(msg.IsMine ? "mine" : "theirs")">
                        <div class="sender">@msg.SenderUsername</div>
                        <div class="content">@msg.Content</div>
                    </div>
                }
            </div>

            <div class="chat-input">
                <input @bind="message" placeholder="Type a message..." />
                <button @onclick="SendMessage">Send</button>
            </div>
        </div>
    </div>
}

@code {
    private Guid roomId;
    private Guid currentRoom = Guid.Empty;
    private List<RoomDto> availableRooms = new();
    private string message = "";

    private bool CanJoinRoom => roomId != Guid.Empty && availableRooms.Any(r => r.Id == roomId);

    protected override async Task OnInitializedAsync()
    {
        var token = await AuthService.GetTokenAsync();
        if (string.IsNullOrWhiteSpace(token))
        {
            Navigation.NavigateTo("/login", true);
            return;
        }

        ChatService.SetToken(token);
        ChatService.OnMessageReceived += StateHasChanged;
        ChatService.OnUsersUpdated += StateHasChanged;

        await ChatService.ConnectAsync();
        availableRooms = await ChatService.GetAvailableRoomsAsync();
    }

    private void SelectRoom(Guid id)
    {
        roomId = id;
    }

    private async Task JoinRoom()
    {
        if (!CanJoinRoom) return;

        await ChatService.JoinRoomAsync(roomId);
        currentRoom = roomId;
        await JS.InvokeVoidAsync("showToastr", $"✅ Joined Room: {roomId}");
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(message) && currentRoom != Guid.Empty)
        {
            await ChatService.SendMessageAsync(currentRoom, "Me", message);
            message = "";
        }
    }
}
